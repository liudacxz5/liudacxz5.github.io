---
title: oracle学习笔记-表空间、区、段、数据块
date: 2025-04-13 16:44:03
updated: 2025-04-13 16:44:03
tags:
 - oracle
categories:
 - 技术
 - oracle
keywords:
 - Oracle
 - 表空间
 - 区
 - 段
 - 数据块
description: 表空间、区、段、数据块的基础知识和关系
---
Oracle数据库的存储结构分为逻辑结构和物理结构。逻辑结构包括表空间（Tablespace）、段（Segment）、区（Extent）和数据块（Data Block），它们共同管理数据的组织和存储。以下是这些核心概念的详细介绍：

---

### **1. 数据块（Data Block）**
- **定义**：  
  数据块是Oracle中最小的I/O操作单元，通常大小为 **8KB**（可配置为2KB~32KB）。
- **组成**：
  - **块头（Header）**：存储块的元数据（如块地址、事务信息）。
  - **表目录（Table Directory）**：记录块中存储的表信息。
  - **行目录（Row Directory）**：指向块中各行数据的位置。
  - **空闲空间（Free Space）**：未使用的区域，用于插入新数据或更新现有数据。
  - **行数据（Row Data）**：实际存储的数据行。
- **关键参数**：
  - **`PCTFREE`**：块中保留的空闲空间比例（默认10%），用于更新现有行。
  - **`PCTUSED`**：块使用率低于此值时，重新允许插入数据（仅手动段管理有效）。
- **示例**：
  ```sql
  CREATE TABLE employees (
    id NUMBER,
    name VARCHAR2(50)
  ) PCTFREE 20 PCTUSED 40;  -- 设置块的空闲和重用阈值
  ```

---

### **2. 区（Extent）**
- **定义**：  
  区是由**连续数据块**组成的逻辑存储单元，用于为段（如表、索引）分配空间。
- **特点**：
  - 当段需要更多空间时，Oracle自动分配一个区。
  - 区的大小由表空间的存储参数（如`INITIAL`、`NEXT`）决定。
- **示例**：
  ```sql
  CREATE TABLE sales (
    sale_id NUMBER,
    amount NUMBER
  ) STORAGE (
    INITIAL 64K   -- 初始区大小
    NEXT 128K     -- 后续区大小
    MAXEXTENTS 100 -- 最大区数量
  );
  ```

---

### **3. 段（Segment）**
- **定义**：  
  段是数据库对象（如表、索引）的存储容器，由多个区组成。
- **类型**：
  - **数据段（Data Segment）**：存储表或簇的数据。
  - **索引段（Index Segment）**：存储索引数据。
  - **临时段（Temporary Segment）**：用于排序或临时表操作。
  - **回滚段（Undo Segment）**：存储事务回滚信息。
- **管理方式**：
  - **自动段空间管理（ASSM）**：使用位图管理空闲块（推荐）。
  - **手动段空间管理**：使用空闲列表（Freelist）跟踪可用块。
- **示例**：
  ```sql
  -- 查看表的段信息
  SELECT segment_name, segment_type, blocks, extents
  FROM user_segments
  WHERE segment_name = 'EMPLOYEES';
  ```

---

### **4. 表空间（Tablespace）**
- **定义**：  
  表空间是数据库的顶级逻辑存储结构，由多个数据文件（物理文件）组成。
- **类型**：
  - **系统表空间（SYSTEM）**：存储数据字典和系统对象。
  - **用户表空间（USERS）**：存储用户数据。
  - **临时表空间（TEMP）**：处理排序和临时操作。
  - **撤销表空间（UNDO）**：管理事务回滚数据。
- **管理方式**：
  - **本地管理表空间（Locally Managed）**：使用位图跟踪区的分配（默认）。
  - **字典管理表空间（Dictionary Managed）**：通过数据字典管理（已淘汰）。
- **示例**：
  ```sql
  -- 创建表空间
  CREATE TABLESPACE app_data
  DATAFILE '/u01/oracle/data/app01.dbf' SIZE 100M
  AUTOEXTEND ON NEXT 10M MAXSIZE 1G
  EXTENT MANAGEMENT LOCAL  -- 本地管理
  SEGMENT SPACE MANAGEMENT AUTO;  -- 自动段管理
  ```

---

### **5. 四者的层次关系**
1. **数据库** → 多个 **表空间**  
2. **表空间** → 多个 **段**  
3. **段** → 多个 **区**  
4. **区** → 多个 **数据块**  
5. **数据块** → 存储实际数据行

---

### **6. 关键区别与联系**
| **概念**   | **作用**                     | **示例**                  | **管理对象**       |
|------------|------------------------------|---------------------------|--------------------|
| 表空间     | 逻辑存储容器                 | `USERS`, `TEMP`           | 数据文件、段       |
| 段         | 存储数据库对象（表、索引）   | 表的数据段、索引段        | 区                 |
| 区         | 分配存储空间的基本单元       | 初始区、扩展区            | 数据块             |
| 数据块     | 最小I/O单元，存储实际数据    | 8KB或16KB的块             | 行数据、元数据     |

---

### **7. 实际应用场景**
1. **空间规划**  
   - 为表空间分配足够的数据文件，避免频繁扩展。
2. **性能优化**  
   - 调整数据块大小（如OLTP使用8KB，数据仓库使用32KB）。
3. **碎片管理**  
   - 定期合并碎片化的区（`ALTER TABLE ... COALESCE`）。
4. **监控空间使用**  
   - 查询`DBA_SEGMENTS`、`DBA_EXTENTS`视图分析段和区的分布。

---

### **8. 常见问题**
1. **区分配失败**  
   - 表空间无剩余空间，或达到`MAXEXTENTS`限制。
2. **行迁移/行链接**  
   - 数据块过小或`PCTFREE`设置不合理导致。
3. **临时表空间膨胀**  
   - 大规模排序操作未释放临时段，需定期清理。

---

通过理解表空间、段、区和数据块的关系，可以更高效地设计和管理Oracle数据库的存储结构，优化性能和资源利用率。